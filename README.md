# Persona Interest Controller for AstrBot

一个为 [AstrBot](https://github.com/AstrBotDevs/AstrBot) 设计的、高度智能的对话决策插件。它赋予你的 AI 人格一个“心智”，使其能够根据对话上下文、自身设定以及互动方式，来判断是否应该回复、以何种情绪回复，从而彻底告别机械式的“有问必答”。

## 核心功能

-   **🧠 智能回复决策**: 使用一个独立的、可配置的 LLM 来深度分析对话上下文，并根据详尽的规则（如话题相关性、是否被打断、是否被直接`@`等）来决定是否应该做出回应。
-   **🎭 动态情感注入**: 当决定回复时，插件会分析出当前人格应有的“兴趣”和“感觉”，并将其作为强制性指令注入到最终的回复生成模型中，让每一次回复都充满“性格”。
-   **📚 持久化上下文记忆**: 插件独立维护每个会话（群聊/私聊）的聊天记录，并支持配置记录长度。即使 AstrBot 重启，记忆也不会丢失。
-   **👤 精准的用户识别**: 历史记录会包含用户的昵称和QQ号，让分析模型能清晰地理解对话的参与者和流向。
-   **✅ 全面白名单控制**: 通过统一的白名单，您可以精确控制插件在哪些群聊或私聊中生效。
-   **🎲 可配置随机性**: 引入“随机回复”机制，即使在应该回复的情况下，机器人也会进行一次概率检定，使其行为更加自然、难以预测。
-   **🛠️ 内置管理工具**: 提供简单的指令，让您可以随时查看或清空某个会话的聊天记录，方便调试和管理。

## 安装

1.  **下载插件**: 克隆或下载本仓库。
2.  **放置文件**: 将整个插件文件夹（例如 `persona_interest_controller`）放置到您 AstrBot 的 `data/plugins/` 目录下。
3.  **重载插件**: 启动或在 AstrBot WebUI 中重载所有插件。插件所需的 `aiofiles` 库将会被自动安装。

## 配置

在 AstrBot WebUI 的插件管理页面，找到本插件并点击“管理”，您将看到以下配置项：

-   **`白名单 (同时适用于群聊和私聊)`**:
    -   **功能**: 控制插件的生效范围。
    -   **设置**: 填写群号或用户QQ号的列表。只有列表中的群聊或私聊会话才会启用本插件。

-   **`用于分析的LLM供应商ID`**:
    -   **功能**: 指定一个专门用于进行对话分析的 LLM 服务商。
    -   **设置**: 填写您在 AstrBot 供应商设置中配置的供应商ID。**强烈建议**使用一个速度快、成本低的便宜模型，因为它只负责分析和输出JSON，不需要强大的文学创作能力。

-   **`最大历史记录条数`**:
    -   **功能**: 设置每个会话最多保存多少条聊天记录（一问一答算两条）。
    -   **设置**: 一个整数，例如 `20`。当记录超过此数量时，最早的记录会被自动删除。

-   **`在历史记录中保存情感状态`**:
    -   **功能**: 一个调试开关。
    -   **设置**: 设为 `true` 后，在使用 `/history_ctrl view` 查看历史记录时，会一并显示机器人每次回复时的情感状态。默认为 `false`。

-   **`随机回复概率 (0.0 - 1.0)`**:
    -   **功能**: 为机器人的回复增加不确定性。
    -   **设置**: 一个0到1之间的小数。`1.0` 代表只要分析模型认为该回，就总是回复。`0.5` 代表有50%的几率在决定回复后“保持沉默”。

-   **`分析模型的系统提示词`**:
    -   **功能**: 指导分析模型如何工作的核心指令。
    -   **设置**: 插件已内置一个非常强大和详尽的默认提示词。除非您非常了解其工作原理，否则不建议修改。

## 使用方法

插件的核心功能是全自动的，配置完成后即可在白名单会话中静默运行。

您也可以使用以下指令来管理聊天记录：

-   **/history_ctrl view**
    -   功能: 查看当前会话（您所在的群聊或私聊）被插件记录的聊天历史。
-   **/history_ctrl clear**
    -   功能: 清空当前会话的聊天历史。

## License

[MIT](LICENSE)